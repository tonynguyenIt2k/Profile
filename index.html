<!doctype html>
<html lang="vi" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#6750A4" />
  <title>Profile — Nguyễn Văn Đại</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,500,0,0&display=swap" rel="stylesheet">

  <style>
    :root{
      color-scheme: light dark;
      --radius-lg: 24px;

      --md-primary: 103 80 164;
      --md-on-primary: 255 255 255;
      --md-primary-container: 234 221 255;
      --md-on-primary-container: 33 0 93;

      --md-tertiary: 125 82 96;
      --md-bg: 248 246 251;
      --md-surface: 255 255 255;
      --md-surface-2: 245 243 250;
      --md-surface-3: 239 236 246;
      --md-outline: 203 198 214;

      --md-text: 28 27 31;
      --md-muted: 93 88 99;
      --md-link: 18 99 209;

      --e1: 0 1px 2px rgba(0,0,0,.08), 0 1px 3px rgba(0,0,0,.06);
      --e2: 0 6px 14px rgba(0,0,0,.10), 0 2px 6px rgba(0,0,0,.06);
      --e3: 0 14px 30px rgba(0,0,0,.14), 0 6px 14px rgba(0,0,0,.08);

      --ring: 0 0 0 4px rgba(103,80,164,.18);
    }
    html[data-theme="dark"]{
      --md-primary: 208 188 255;
      --md-on-primary: 55 30 115;
      --md-primary-container: 79 55 139;
      --md-on-primary-container: 234 221 255;

      --md-tertiary: 239 184 200;
      --md-bg: 16 14 20;
      --md-surface: 24 22 29;
      --md-surface-2: 30 27 35;
      --md-surface-3: 36 32 42;
      --md-outline: 73 69 79;

      --md-text: 231 224 236;
      --md-muted: 200 191 207;
      --md-link: 156 199 255;

      --e1: 0 1px 2px rgba(0,0,0,.40);
      --e2: 0 8px 20px rgba(0,0,0,.45);
      --e3: 0 18px 40px rgba(0,0,0,.55);

      --ring: 0 0 0 4px rgba(208,188,255,.20);
    }

    /* Smooth theme transitions when switching themes */
    @media (prefers-reduced-motion: no-preference) {
      .theme-transition body,
      .theme-transition .appbar,
      .theme-transition .card,
      .theme-transition .modal,
      .theme-transition .btn,
      .theme-transition .input,
      .theme-transition .chip,
      .theme-transition .cover {
        transition: background-color .28s ease, color .28s ease, border-color .28s ease, box-shadow .28s ease, transform .18s ease;
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: rgb(var(--md-bg));
      color: rgb(var(--md-text));
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{ color: rgb(var(--md-link)); text-decoration:none; }
    a:hover{ text-decoration: underline; }

    .icon{
      font-family: "Material Symbols Rounded";
      font-weight: 500;
      font-style: normal;
      font-size: 22px;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      /* Force filled icons so they don't blend with white backgrounds (use FILL=1) */
      font-variation-settings: 'FILL' 1, 'wght' 500, 'GRAD' 0;
    }

    .appbar{
      position: sticky; top:0; z-index: 20;
      backdrop-filter: blur(12px);
      background: color-mix(in oklab, rgb(var(--md-surface)) 78%, transparent);
      border-bottom: 1px solid rgba(var(--md-outline), .55);
    }
    .appbar-inner{
      max-width: 1160px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 220px; }
    .brand-badge{
      width: 40px; height: 40px;
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(var(--md-primary),.90), rgba(var(--md-tertiary),.75));
      box-shadow: var(--e1);
      display:grid; place-items:center;
    }
    .brand h1{ font-size: 16px; margin:0; letter-spacing: .2px; font-weight: 600; }
    .brand p{ margin:2px 0 0 0; font-size: 12px; color: rgb(var(--md-muted)); }
    .app-actions{
      display:flex; gap:10px; align-items:center;
      flex-wrap: wrap; justify-content:flex-end;
    }

    .container{ max-width: 1160px; margin: 0 auto; padding: 18px 16px 42px; }
    .grid{ display:grid; grid-template-columns: 360px 1fr; gap: 16px; align-items: start; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } .brand{ min-width:0; } }

    .card{
      border-radius: var(--radius-lg);
      background: rgb(var(--md-surface));
      box-shadow: var(--e1);
      border: 1px solid rgba(var(--md-outline), .45);
      overflow: hidden;
    }
    .card.pad{ padding: 16px; }
    .subtle{ background: rgb(var(--md-surface-2)); }

    .row{ display:flex; gap: 12px; align-items:center; }
    .stack{ display:grid; gap: 10px; }
    .muted{ color: rgb(var(--md-muted)); }

    .btn{
      position: relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      height: 40px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: rgb(var(--md-surface));
      color: rgb(var(--md-text));
      font-weight: 600;
      cursor: pointer;
      transition: transform .08s ease, background .15s ease, box-shadow .15s ease;
      user-select:none;
      overflow:hidden;
      white-space: nowrap;
    }
    .btn:hover{ background: rgb(var(--md-surface-2)); }
    .btn:active{ transform: scale(.98); }
    .btn:focus{ outline:none; box-shadow: var(--ring); }
    .btn.primary{ border-color: transparent; background: rgb(var(--md-primary)); color: rgb(var(--md-on-primary)); }
    .btn.primary:hover{ background: color-mix(in oklab, rgb(var(--md-primary)) 92%, black); }
    .btn.tonal{ border-color: transparent; background: rgb(var(--md-primary-container)); color: rgb(var(--md-on-primary-container)); }
    .btn.icon{ width: 40px; padding:0; }
    .btn.danger{ border-color: rgba(239,68,68,.55); }
    .btn.danger:hover{ background: rgba(239,68,68,.08); }

    .btn .ripple{
      position:absolute; inset:0;
      pointer-events:none;
      background: radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(255,255,255,.35), transparent 55%);
      opacity:0;
      transition: opacity .35s ease;
    }
    .btn.primary .ripple{ background: radial-gradient(circle at var(--x,50%) var(--y,50%), rgba(255,255,255,.45), transparent 55%); }
    .btn:active .ripple{ opacity:1; transition: opacity .05s ease; }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: rgb(var(--md-surface));
      font-weight: 600;
      font-size: 13px;
      color: rgb(var(--md-text));
    }
    .chips{ display:flex; flex-wrap: wrap; gap: 10px; }
    .divider{ height:1px; background: rgba(var(--md-outline), .45); margin: 14px 0; }

    .section-title{ display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 10px; }
    .section-title h2{ margin:0; font-size: 15px; letter-spacing: .2px; }

    .field{ display:grid; gap: 6px; }
    .input{
      height: 48px;
      border-radius: 12px;
      padding: 0 14px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: color-mix(in oklab, rgb(var(--md-surface)) 96%, transparent);
      color: rgb(var(--md-text));
      font-size: 15px;
      outline:none;
      transition: box-shadow .18s cubic-bezier(.2,.9,.2,1), border-color .15s ease, background .15s ease, transform .06s ease;
      box-shadow: 0 1px 0 rgba(16,14,20,0.02);
    }
    .input::placeholder{ color: rgba(var(--md-muted), .8); }
    .input:focus{ border-color: rgba(var(--md-primary), .9); box-shadow: 0 6px 18px rgba(103,80,164,.12); transform: translateY(-1px); }
    textarea.input{ height:auto; padding: 12px 14px; min-height: 120px; resize: vertical; font-size:15px; }

    .cover{
      height: 62px;
      background: radial-gradient(900px 220px at 20% 20%, rgba(var(--md-primary), .40), transparent 50%),
                  radial-gradient(700px 240px at 85% 60%, rgba(var(--md-tertiary), .35), transparent 55%),
                  linear-gradient(135deg, rgba(var(--md-primary), .22), rgba(var(--md-tertiary), .18));
    }
    .profile-head{ padding: 0 16px 16px; margin-top: -44px; }
    .avatar{
      width: 92px; height: 92px;
      border-radius: 28px;
      background: rgb(var(--md-surface-3));
      border: 4px solid rgb(var(--md-surface));
      box-shadow: var(--e2);
      display:grid; place-items:center;
      overflow:hidden;
      position: relative;
    }
    .avatar img{ width:100%; height:100%; object-fit: cover; display:block; }
    .name{ margin: 10px 0 2px; font-size: 20px; font-weight: 800; letter-spacing: .2px; }
    .role{ font-size: 13px; color: rgb(var(--md-muted)); display:flex; gap: 8px; align-items:center; flex-wrap:wrap; }

    .stats{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .stat{
      padding: 12px;
      border-radius: 18px;
      background: rgb(var(--md-surface-2));
      border: 1px solid rgba(var(--md-outline), .45);
      text-align:center;
    }
    .stat b{ display:block; font-size: 16px; }
    .stat span{ font-size: 12px; color: rgb(var(--md-muted)); }

    .projects{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    @media (max-width: 560px){ .projects{ grid-template-columns: 1fr; } .stats{ grid-template-columns: 1fr 1fr; } }
    .p-card{
      padding: 14px;
      border-radius: 22px;
      background: rgb(var(--md-surface));
      border: 1px solid rgba(var(--md-outline), .45);
      box-shadow: var(--e1);
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .p-card:hover{ transform: translateY(-2px); box-shadow: var(--e2); }
    .p-top{ display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .p-title{ margin:0; font-size: 14px; font-weight: 800; }
    .p-desc{ margin: 8px 0 10px; font-size: 13px; color: rgb(var(--md-muted)); line-height: 1.45; }
    .p-tags{ display:flex; gap: 8px; flex-wrap: wrap; }
    .tag{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgb(var(--md-surface-2));
      border: 1px solid rgba(var(--md-outline), .45);
      color: rgb(var(--md-text));
      font-weight: 700;
    }

    .foot{
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgb(var(--md-surface-2));
      border: 1px solid rgba(var(--md-outline), .45);
      color: rgb(var(--md-muted));
      font-size: 12px;
      display:flex; justify-content:space-between; gap: 10px; flex-wrap:wrap;
    }

    /* Backdrop / Modal */
    .backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.42);
      display:none;
      pointer-events: none;
      z-index: 60;
      padding: 18px;
    }
    .backdrop.show{ display:grid; place-items:center; pointer-events: auto; }
    .modal{
      width: min(860px, 96%);
      max-height: min(88vh, 920px);
      overflow:auto;
      border-radius: 20px;
      background: linear-gradient(180deg, color-mix(in oklab, rgb(var(--md-surface)) 96%, transparent), rgb(var(--md-surface)) 100%);
      border: 1px solid rgba(var(--md-outline), .45);
      box-shadow: 0 10px 30px rgba(16,14,20,0.12), 0 6px 12px rgba(16,14,20,0.06);
    }
    .modal-head{
      position: sticky; top:0; z-index: 3;
      padding: 18px 20px;
      display:flex; align-items:center; justify-content:space-between; gap: 14px;
      background: color-mix(in oklab, rgb(var(--md-surface)) 92%, transparent);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(var(--md-outline), .35);
      box-shadow: 0 6px 18px rgba(16,14,20,0.04);
    }
    .modal-head h3{ margin:0; font-size: 17px; letter-spacing:.2px; font-weight:800; }
    .modal-head .subtitle{ font-size:13px; color: rgb(var(--md-muted)); margin-top:2px; }
    .modal-body{ padding: 18px 20px 22px; display:grid; gap: 16px; }
    .modal-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px){ .modal-grid{ grid-template-columns: 1fr; } }
    .hint{ font-size: 13px; color: rgb(var(--md-muted)); margin-top: 6px; }

    /* Modal inputs */
    .modal .input{ height:46px; border-radius:12px; padding: 0 14px; font-size:14px; }
    .modal textarea.input{ min-height:110px; padding:12px 14px; }
    .modal .avatar{ width:120px; height:120px; border-radius:18px; }
    .modal .cam{ width:34px; height:34px; border-radius:10px; }

    .kbd{
      font-size: 12px; font-weight: 700;
      padding: 3px 8px; border-radius: 10px;
      border: 1px solid rgba(var(--md-outline),.55);
      background: rgb(var(--md-surface-2));
    }

    /* Toast */
    .toast-wrap{ position: fixed; right: 14px; top: 14px; z-index: 80; display:grid; gap: 8px; }
    .toast{
      border-radius: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: color-mix(in oklab, rgb(var(--md-surface)) 86%, transparent);
      backdrop-filter: blur(10px);
      box-shadow: var(--e2);
      display:flex; gap: 10px; align-items:flex-start;
      max-width: 380px;
    }
    .toast b{ display:block; font-size: 13px; }
    .toast p{ margin: 2px 0 0; font-size: 12px; color: rgb(var(--md-muted)); }
    .toast.ok{ border-color: rgba(34,197,94,.45); }
    .toast.err{ border-color: rgba(239,68,68,.45); }

    /* Project editor */
    .plist{ display:grid; gap: 10px; }
    .pitem{
      border-radius: 18px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: rgb(var(--md-surface));
      padding: 12px;
      display:grid;
      gap: 10px;
    }
    .pitem.dragging{ opacity: .85; box-shadow: var(--e2); outline: 2px dashed rgba(var(--md-primary), .55); outline-offset: 2px; }
    .pitem .head{ display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .pitem .left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
    .drag-handle{
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: rgb(var(--md-surface-2));
      display:grid; place-items:center;
      cursor: grab;
      user-select:none;
      flex: 0 0 auto;
    }
    .drag-handle:active{ cursor: grabbing; }
    .pitem-title{ display:grid; gap: 2px; min-width: 0; }
    .pitem-title b{ font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pitem-title small{ font-size: 12px; color: rgb(var(--md-muted)); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .pitem .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 720px){ .pitem .grid3{ grid-template-columns: 1fr; } }
    .mini{ height: 38px; border-radius: 12px; padding: 0 10px; font-size: 13px; }

    .badge{
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: rgb(var(--md-surface-2));
      color: rgb(var(--md-text));
      font-weight: 700;
      display:inline-flex; gap: 6px; align-items:center;
    }
    .dropzone{
      border-radius: 18px;
      padding: 10px 12px;
      border: 1px dashed rgba(var(--md-outline), .75);
      color: rgb(var(--md-muted));
      font-size: 12px;
      text-align:center;
      background: color-mix(in oklab, rgb(var(--md-surface-2)) 86%, transparent);
    }
    .dropzone.on{ border-color: rgba(var(--md-primary), .75); box-shadow: var(--ring); }

    /* Small dialog */
    .dlg{
      width: min(560px, 100%);
      border-radius: 26px;
      background: rgb(var(--md-surface));
      border: 1px solid rgba(var(--md-outline), .55);
      box-shadow: var(--e3);
      overflow:hidden;
    }
    .dlg-head{
      padding: 14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
      border-bottom: 1px solid rgba(var(--md-outline), .45);
      background: color-mix(in oklab, rgb(var(--md-surface)) 86%, transparent);
      backdrop-filter: blur(12px);
    }
    .dlg-head h4{ margin:0; font-size: 15px; letter-spacing:.2px; }
    .dlg-body{ padding: 14px; display:grid; gap: 12px; }
    .dlg-actions{ padding: 14px; display:flex; gap: 10px; justify-content:flex-end; border-top: 1px solid rgba(var(--md-outline), .45); }
    .sr-only{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }

    /* MOBILE DOCK */
    .mobile-dock{
      position: fixed;
      left: 12px; right: 12px; bottom: 12px;
      z-index: 50;
      padding: 10px;
      border-radius: 22px;
      background: color-mix(in oklab, rgb(var(--md-surface)) 86%, transparent);
      border: 1px solid rgba(var(--md-outline), .55);
      box-shadow: var(--e2);
      backdrop-filter: blur(14px);
      display: none;
    }
    .dock-grid{
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }
    .dock-btn{
      height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(var(--md-outline), .55);
      background: rgb(var(--md-surface));
      display: grid;
      place-items: center;
      gap: 2px;
      cursor: pointer;
      user-select: none;
      transition: transform .08s ease, background .15s ease;
    }
    .dock-btn:hover{ background: rgb(var(--md-surface-2)); }
    .dock-btn:active{ transform: scale(.98); }
    .dock-btn .label{ font-size: 11px; color: rgb(var(--md-muted)); font-weight: 700; }
    .dock-btn.primary{
      border-color: transparent;
      background: rgb(var(--md-primary));
      color: rgb(var(--md-on-primary));
    }
    .dock-btn.primary .label{ color: rgba(var(--md-on-primary), .9); }

    @media (max-width: 820px){
      .app-actions{ display:none; }
      .mobile-dock{ display:block; }
      .container{ padding-bottom: 110px; }
    }
  </style>
</head>

<body>
  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <header class="appbar">
    <div class="appbar-inner">
      <div class="brand">
        <div class="brand-badge"><span class="icon">person</span></div>
        <div>
          <h1>Hồ sơ cá nhân</h1>
          <p>Material Design • Firebase Sync</p>
        </div>
      </div>

      <div class="app-actions">
        <button class="btn icon" id="themeBtn" title="Đổi giao diện (Dark/Light)" aria-label="Đổi giao diện">
          <span class="icon" id="themeIcon">dark_mode</span><span class="ripple"></span>
        </button>

        <button class="btn tonal" id="lockBtn" title="Đặt/đổi mật khẩu chỉnh sửa">
          <span class="icon">lock</span>Khoá sửa<span class="ripple"></span>
        </button>

        <button class="btn tonal" id="exportBtn" title="Xuất JSON">
          <span class="icon">download</span>Export<span class="ripple"></span>
        </button>

        <button class="btn tonal" id="importBtn" title="Nhập JSON">
          <span class="icon">upload</span>Import<span class="ripple"></span>
        </button>

        <button class="btn" id="downloadCvBtn" title="Tải CV">
          <span class="icon">file_download</span>CV<span class="ripple"></span>
        </button>
        <button class="btn" id="quickDownloadBtn" title="Tải nhanh CV">
          <span class="icon">download</span>Tải nhanh<span class="ripple"></span>
        </button>

        <button class="btn" id="pushSampleBtn" title="Đẩy sample lên Firebase">
          <span class="icon">cloud_upload</span>Push sample<span class="ripple"></span>
        </button>
        <button class="btn" id="syncNowBtn" title="Đồng bộ lên Firebase">
          <span class="icon">cloud_done</span>Sync<span class="ripple"></span>
        </button>

        <button class="btn primary" id="editBtn" title="Chỉnh sửa hồ sơ">
          <span class="icon">edit</span>Chỉnh sửa<span class="ripple"></span>
        </button>

        <input class="sr-only" type="file" id="importFile" accept="application/json,.json">
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <aside class="card">
        <div class="cover"></div>

        <div class="profile-head">
          <div class="row" style="justify-content:space-between;">
            <div class="row">
              <div class="avatar" title="Ảnh đại diện">
                <img id="ui_avatar" src="" alt="Avatar">
              </div>
            </div>

            <span class="chip" id="syncBadge"><span class="icon" style="font-size:18px">cloud</span>Offline</span>
          </div>

          <div class="name" id="ui_name"></div>
          <div class="role">
            <span class="chip"><span class="icon" style="font-size:18px">work</span><span id="ui_title"></span></span>
            <span class="chip"><span class="icon" style="font-size:18px">location_on</span><span id="ui_location"></span></span>
          </div>

          <div class="stats">
            <div class="stat"><b id="ui_stat_projects"></b><span>Dự án</span></div>
            <div class="stat"><b id="ui_stat_followers"></b><span>Theo dõi</span></div>
            <div class="stat"><b id="ui_stat_rating"></b><span>Đánh giá</span></div>
            <div class="stat"><b id="ui_stat_experience"></b><span>Kinh nghiệm</span></div>
            <div class="stat"><b id="ui_stat_clients"></b><span>Khách hàng</span></div>
            <div class="stat"><b id="ui_stat_awards"></b><span>Giải thưởng</span></div>
          </div>

          <div class="divider"></div>

          <div class="stack">
            <div class="section-title"><h2>Liên hệ</h2></div>

            <div class="row">
              <span class="icon">call</span>
              <div>
                <div style="font-weight:700" id="ui_phone"></div>
                <div class="muted" style="font-size:12px">Hotline / Zalo</div>
              </div>
            </div>

            <div class="row">
              <span class="icon">mail</span>
              <div>
                <div style="font-weight:700"><a id="ui_email_link" href="#">-</a></div>
                <div class="muted" style="font-size:12px">Email công việc</div>
              </div>
            </div>

            <div class="row">
              <span class="icon">language</span>
              <div>
                <div style="font-weight:700"><a id="ui_site_link" href="#" target="_blank" rel="noopener">-</a></div>
                <div class="muted" style="font-size:12px">Portfolio</div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="stack">
            <div class="section-title"><h2>Kỹ năng nổi bật</h2></div>
            <div class="chips" id="ui_skills"></div>
          </div>
        </div>
      </aside>

      <section class="stack">
        <div class="card pad">
          <div class="section-title">
            <h2>Giới thiệu</h2>
            <span class="chip"><span class="icon" style="font-size:18px">verified</span>Pro</span>
          </div>
          <p class="muted" id="ui_bio" style="margin:0; line-height:1.6;"></p>

          <div class="divider"></div>

          <div class="projects">
            <div class="p-card">
              <div class="p-top">
                <p class="p-title">Sync Firebase</p>
                <span class="chip"><span class="icon" style="font-size:18px">cloud_sync</span>Realtime</span>
              </div>
              <p class="p-desc">Dữ liệu lưu Firestore theo UID (đăng nhập ẩn danh) và tự đồng bộ đa thiết bị.</p>
              <div class="p-tags"><span class="tag">Auth</span><span class="tag">Firestore</span></div>
            </div>
            <div class="p-card">
              <div class="p-top">
                <p class="p-title">Khoá chỉnh sửa</p>
                <span class="chip"><span class="icon" style="font-size:18px">lock</span>Protected</span>
              </div>
              <p class="p-desc">Bật mật khẩu để ngăn người khác mở modal chỉnh sửa trên máy.</p>
              <div class="p-tags"><span class="tag">WebCrypto</span><span class="tag">Dialog</span></div>
            </div>
          </div>
        </div>

        <div class="card pad">
          <div class="section-title">
            <h2>Dự án nổi bật</h2>
            <div class="row">
              <input class="input" id="search" placeholder="Tìm dự án..." />
              <button class="btn icon" id="resetProfileBtn" title="Reset hồ sơ">
                <span class="icon">restart_alt</span><span class="ripple"></span>
              </button>
            </div>
          </div>
          <div class="projects" id="projectGrid"></div>
        </div>

        <div class="card pad subtle">
          <div class="section-title">
            <h2>Gửi yêu cầu hợp tác</h2>
            <span class="chip"><span class="icon" style="font-size:18px">shield</span>Anti-spam</span>
          </div>

          <div class="projects" style="grid-template-columns: 1fr 1fr;">
            <label class="field"><span class="muted" style="font-size:12px">Họ tên</span><input class="input" placeholder="Ví dụ: Nguyễn A" /></label>
            <label class="field"><span class="muted" style="font-size:12px">Số điện thoại</span><input class="input" placeholder="Ví dụ: 09xx..." /></label>
          </div>
          <div class="projects" style="grid-template-columns: 1fr;">
            <label class="field"><span class="muted" style="font-size:12px; margin-top:6px">Nội dung</span><input class="input" placeholder="Bạn cần website/landing page/hệ thống quản trị..." /></label>
          </div>

          <div class="row" style="justify-content:flex-end; margin-top: 10px;">
            <button class="btn primary"><span class="icon">send</span>Gửi yêu cầu<span class="ripple"></span></button>
          </div>

          <div class="foot">
            <span>Bản quyền thuộc về Tony Nguyễn</span>
            <span>© <span id="year"></span> Profile</span>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- EDIT MODAL -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="modal-head">
        <div class="row" style="gap:10px;">
          <span class="icon">edit_square</span>
          <h3 id="modalTitle">Chỉnh sửa hồ sơ</h3>
        </div>
        <div class="row">
          <button class="btn" id="closeModalBtn"><span class="icon">close</span>Đóng<span class="ripple"></span></button>
          <button class="btn primary" id="saveBtn"><span class="icon">save</span>Lưu<span class="ripple"></span></button>
        </div>
      </div>

      <div class="modal-body">
        <div class="card pad subtle" style="border-radius:22px;">
          <div class="section-title" style="margin-bottom:6px;">
            <h2>Ảnh đại diện</h2>
            <span class="chip"><span class="icon" style="font-size:18px">cloud_done</span>Local + Firebase</span>
          </div>
          <div class="row" style="align-items:flex-start; flex-wrap:wrap;">
            <div class="avatar" style="width:110px;height:110px;border-radius:34px;">
              <img id="previewAvatar" src="" alt="Avatar preview">
            </div>
            <div class="stack" style="flex:1; min-width: 220px;">
              <label class="field">
                <span class="muted" style="font-size:12px">Chọn ảnh (jpg/png)</span>
                <input class="input" style="padding: 9px 12px;" type="file" id="avatarFile" accept="image/*">
                <div class="hint">Ảnh lưu base64 (đừng chọn ảnh quá lớn).</div>
              </label>
              <div class="row" style="justify-content:flex-start;">
                <button class="btn" id="removeAvatarBtn"><span class="icon">delete</span>Xoá ảnh<span class="ripple"></span></button>
              </div>
            </div>
          </div>
        </div>

        <div class="card pad" style="border-radius:22px;">
          <div class="section-title"><h2>Thông tin cơ bản</h2></div>
          <div class="modal-grid">
            <label class="field"><span class="muted" style="font-size:12px">Họ tên</span><input class="input" id="f_name"></label>
            <label class="field"><span class="muted" style="font-size:12px">Chức danh</span><input class="input" id="f_title"></label>
            <label class="field"><span class="muted" style="font-size:12px">Vị trí</span><input class="input" id="f_location"></label>
            <label class="field"><span class="muted" style="font-size:12px">Số điện thoại</span><input class="input" id="f_phone"></label>
            <label class="field"><span class="muted" style="font-size:12px">Email</span><input class="input" id="f_email"></label>
            <label class="field"><span class="muted" style="font-size:12px">Website</span><input class="input" id="f_site"><div class="hint">Thiếu http/https sẽ tự thêm https://</div></label>
          </div>
          <div style="height:10px"></div>
          <label class="field"><span class="muted" style="font-size:12px">Giới thiệu</span><textarea class="input" id="f_bio"></textarea></label>
        </div>

        <div class="card pad subtle" style="border-radius:22px;">
          <div class="section-title"><h2>Stats & Kỹ năng</h2></div>
          <div class="modal-grid">
            <label class="field"><span class="muted" style="font-size:12px">Dự án</span><input class="input" id="f_projects" inputmode="numeric"></label>
            <label class="field"><span class="muted" style="font-size:12px">Theo dõi</span><input class="input" id="f_followers"></label>
            <label class="field"><span class="muted" style="font-size:12px">Đánh giá</span><input class="input" id="f_rating"></label>
            <label class="field"><span class="muted" style="font-size:12px">Kinh nghiệm (năm)</span><input class="input" id="f_experience" inputmode="numeric"></label>
            <label class="field"><span class="muted" style="font-size:12px">Khách hàng</span><input class="input" id="f_clients" inputmode="nunberic"></label>
            <label class="field"><span class="muted" style="font-size:12px">Giải thưởng</span><input class="input" id="f_awards" inputmode="numeric"></label>
            <label class="field"><span class="muted" style="font-size:12px">Kỹ năng (phân cách ,)</span><input class="input" id="f_skills"></label>
          </div>
        </div>

        <div class="card pad" style="border-radius:22px;">
          <div class="section-title" style="align-items:flex-start;">
            <div class="stack" style="gap:4px;">
              <h2 style="margin:0;">Quản lý “Dự án nổi bật”</h2>
              <div class="hint">Kéo thả để sắp xếp • Nhấn <span class="kbd">↑</span>/<span class="kbd">↓</span> để đổi nhanh.</div>
            </div>
            <button class="btn tonal" id="addProjectBtn"><span class="icon">add</span>Thêm dự án<span class="ripple"></span></button>
          </div>

          <div class="dropzone" id="dropzone">Thả để đổi vị trí dự án</div>
          <div style="height:10px"></div>
          <div class="plist" id="projectList"></div>
        </div>

        <div class="hint">
          Firebase: lưu tại <code>users/{uid}/profile/main</code> • LocalStorage: <code>profile_data_v1</code>
        </div>
      </div>
    </div>
  </div>

  <!-- DIALOG -->
  <div class="backdrop" id="dlgBackdrop" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="dlg">
      <div class="dlg-head">
        <div class="row" style="gap:10px;">
          <span class="icon" id="dlgIcon">lock</span>
          <h4 id="dlgTitle">Dialog</h4>
        </div>
        <button class="btn icon" id="dlgCloseX" title="Đóng"><span class="icon">close</span><span class="ripple"></span></button>
      </div>
      <div class="dlg-body" id="dlgBody"></div>
      <div class="dlg-actions" id="dlgActions"></div>
    </div>
  </div>

<!-- MOBILE DOCK -->
<nav class="mobile-dock" aria-label="Quick actions">
    <div class="dock-grid">
        <button class="dock-btn" id="dockTheme" title="Dark/Light">
            <span class="icon" style="color: rgb(var(--md-text))">dark_mode</span><div class="label">Theme</div>
        </button>
        <button class="dock-btn" id="dockExport" title="Export">
            <span class="icon" style="color: rgb(var(--md-text))">download</span><div class="label">Export</div>
        </button>
        <button class="dock-btn" id="dockImport" title="Import">
            <span class="icon" style="color: rgb(var(--md-text))">upload</span><div class="label">Import</div>
        </button>
        <button class="dock-btn" id="dockLock" title="Đặt/đổi mật khẩu">
            <span class="icon" style="color: rgb(var(--md-text))">lock</span><div class="label">Khoá</div>
        </button>
        <button class="dock-btn primary" id="dockEdit" title="Chỉnh sửa">
            <span class="icon" style="color: rgb(var(--md-on-primary))">edit</span><div class="label">Edit</div>
        </button>
    </div>
</nav>

  <script type="module">
    // Safety: ensure backdrops are not left visible and blocking clicks on load
    document.addEventListener('DOMContentLoaded', () => {
      try{
        document.getElementById('backdrop')?.classList.remove('show');
        document.getElementById('dlgBackdrop')?.classList.remove('show');
        document.documentElement.style.overflow = '';
      }catch(e){ /* ignore */ }
    });
    // ===== Firebase (Auth anonymous + Firestore) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Firebase config imported from external file
    import { firebaseConfig } from './firebase-config.js';

    // ===== Helpers =====
    const $ = (s) => document.querySelector(s);
    const te = new TextEncoder();
    const td = new TextDecoder();

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Image fallback: replace broken avatar src with default demo avatar
    function attachImageFallback(img){
      if(typeof img === 'string') img = document.querySelector(img);
      if(!img) return;
      img.addEventListener('error', () => {
        try{ img.src = DEFAULT_PROFILE.avatar; }catch(e){}
      });
    }

    // Ripple origin
    document.addEventListener('pointerdown', (e) => {
      const btn = e.target.closest?.('.btn, .dock-btn');
      if(!btn) return;
      const r = btn.getBoundingClientRect();
      btn.style.setProperty('--x', (((e.clientX - r.left) / r.width) * 100) + '%');
      btn.style.setProperty('--y', (((e.clientY - r.top) / r.height) * 100) + '%');
    });

    // Toast
    const toastWrap = $("#toastWrap");
    function toast(type, title, msg){
      const el = document.createElement('div');
      el.className = `toast ${type === 'err' ? 'err' : 'ok'}`;
      el.innerHTML = `
        <span class="icon">${type === 'err' ? 'error' : 'check_circle'}</span>
        <div><b>${escapeHtml(title)}</b><p>${escapeHtml(msg || '')}</p></div>
      `;
      toastWrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity = '0'; el.style.transform = 'translateY(-2px)'; }, 2400);
      setTimeout(()=>{ el.remove(); }, 2900);
    }

    // Theme
    const root = document.documentElement;
    const themeIcon = $("#themeIcon");
    const getPreferred = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    function applyTheme(mode){
      // add a temporary class to enable smooth transitions
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(!prefersReduced){
        root.classList.add('theme-transition');
        window.clearTimeout(root._themeTimeout);
        root._themeTimeout = window.setTimeout(() => { root.classList.remove('theme-transition'); }, 350);
      }

      if(mode === 'auto') root.setAttribute('data-theme', getPreferred());
      else root.setAttribute('data-theme', mode);
      const current = root.getAttribute('data-theme');
      themeIcon.textContent = current === 'dark' ? 'light_mode' : 'dark_mode';
      $('meta[name="theme-color"]').setAttribute('content', current === 'dark' ? '#2B2335' : '#6750A4');
    }
    applyTheme(localStorage.getItem('profile_theme') || 'auto');
    $("#themeBtn").addEventListener('click', () => {
      const current = root.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('profile_theme', next);
      applyTheme(next);
    });

    // Storage
    const STORAGE_KEY = 'profile_data_v1';
    const EDIT_LOCK_KEY = 'profile_edit_lock_v1';

    function safeUrl(u){
      const v = String(u || '').trim();
      if(!v) return '';
      if(/^https?:\/\//i.test(v)) return v;
      return 'https://' + v;
    }
    function uid(){ return 'p_' + Math.random().toString(16).slice(2) + Date.now().toString(16); }

    const DEFAULT_PROFILE = {
      avatar: './assets/img/logo.jpg',
      name: 'Nguyễn Văn A',
      title: 'Full-stack Developer',
      location: 'Hà Nội, Việt Nam',
      phone: '+84 912 345 678',
      email: 'hello@yourdomain.com',
      site: 'https://yourdomain.com',
      bio: 'Tôi xây dựng sản phẩm web/app theo hướng tối ưu trải nghiệm, tốc độ và khả năng mở rộng.',
      stats: { projects: '24', followers: '1.2k', rating: '4.9', experience: '5 năm', clients: '15', awards: '3' },
      skills: ['Laravel','React','UI/UX','MySQL','Automation'],
      projectsFeatured: [
        { id: uid(), title: 'Snack Hub • Multi-tenant', badge: 'Live', badgeIcon: 'rocket_launch', desc: 'Đặt món QR + quản trị + phân quyền.', tags: ['Laravel','RBAC','Dashboard'] },
        { id: uid(), title: 'QR Maker • Print-ready', badge: 'A4/A5', badgeIcon: 'print', desc: 'Template in 58mm, bo góc, tối ưu mobile.', tags: ['UI','PDF','Template'] },
        { id: uid(), title: 'Thiệp cưới • Interactive', badge: 'Pro', badgeIcon: 'favorite', desc: 'Gallery, nhạc nền, hiệu ứng mượt.', tags: ['React','Animation','SEO'] },
        { id: uid(), title: 'Admin CRM • Leads', badge: 'Analytics', badgeIcon: 'insights', desc: 'Pipeline, lọc nâng cao, phân quyền.', tags: ['CRM','Reports','Permissions'] },
      ]
    };

    function normalizeProject(p){
      return {
        id: p.id || uid(),
        title: String(p.title || '').trim(),
        badge: String(p.badge || '').trim(),
        badgeIcon: String(p.badgeIcon || 'rocket_launch').trim(),
        desc: String(p.desc || '').trim(),
        tags: Array.isArray(p.tags) ? p.tags : String(p.tags || '').split(',').map(s=>s.trim()).filter(Boolean)
      };
    }

    function loadProfile(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(DEFAULT_PROFILE);
        const data = JSON.parse(raw);
        const base = structuredClone(DEFAULT_PROFILE);
        const merged = {
          ...base, ...data,
          stats: { ...base.stats, ...(data.stats||{}) },
          skills: Array.isArray(data.skills) ? data.skills : base.skills,
          projectsFeatured: Array.isArray(data.projectsFeatured) ? data.projectsFeatured : base.projectsFeatured
        };
        merged.projectsFeatured = merged.projectsFeatured.map(p => ({ id: p.id || uid(), ...normalizeProject(p) }));
        merged.skills = (merged.skills||[]).map(s=>String(s).trim()).filter(Boolean).slice(0, 24);
        return merged;
      }catch(_){
        return structuredClone(DEFAULT_PROFILE);
      }
    }

    function validateEmail(email){
      const v = String(email||'').trim();
      if(!v) return true;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    // ===== Material Dialog (no confirm popup) =====
    const dlgBackdrop = $("#dlgBackdrop");
    const dlgTitle = $("#dlgTitle");
    const dlgBody = $("#dlgBody");
    const dlgActions = $("#dlgActions");
    const dlgIcon = $("#dlgIcon");

    function dlgClose(){
      dlgBackdrop.classList.remove('show');
      document.documentElement.style.overflow = '';
      dlgBody.innerHTML = '';
      dlgActions.innerHTML = '';
    }
    $("#dlgCloseX").addEventListener('click', dlgClose);
    dlgBackdrop.addEventListener('click', (e)=>{ if(e.target === dlgBackdrop) dlgClose(); });

    function openDialog({icon='info', title='Dialog', bodyHtml='', actions=[]}){
      return new Promise((resolve) => {
        dlgIcon.textContent = icon;
        dlgTitle.textContent = title;
        dlgBody.innerHTML = bodyHtml;
        dlgActions.innerHTML = '';

        const closeAnd = (val) => { dlgClose(); resolve(val); };

        actions.forEach(a => {
          const b = document.createElement('button');
          b.className = `btn ${a.variant || ''}`.trim();
          b.innerHTML = `${a.icon ? `<span class="icon">${a.icon}</span>` : ''}${escapeHtml(a.label)}<span class="ripple"></span>`;
          b.addEventListener('click', () => {
            if(a.onClick) a.onClick(closeAnd);
            else closeAnd(a.value);
          });
          dlgActions.appendChild(b);
        });

        dlgBackdrop.classList.add('show');
        document.documentElement.style.overflow = 'hidden';

        setTimeout(()=>{
          const inp = dlgBody.querySelector('input,textarea,button,select');
          inp?.focus?.();
        }, 30);
      });
    }

    async function confirmDialog({
      title = 'Xác nhận',
      message = 'Bạn chắc chứ?',
      icon = 'help',
      danger = false,
      okText = 'OK',
      cancelText = 'Huỷ'
    } = {}) {
      const body = `
        <div class="card pad subtle" style="border-radius:22px;">
          <div class="section-title" style="margin-bottom:8px;">
            <h2 style="margin:0;font-size:14px;">${escapeHtml(title)}</h2>
            <span class="chip"><span class="icon" style="font-size:18px">${escapeHtml(icon)}</span>${danger ? 'Cẩn thận' : 'Xác nhận'}</span>
          </div>
          <div class="muted" style="font-size:13px;line-height:1.5">${escapeHtml(message)}</div>
        </div>
      `;

      const res = await openDialog({
        icon,
        title,
        bodyHtml: body,
        actions: [
          { label: cancelText, icon:'close', value: false },
          { label: okText, icon:'check', variant: danger ? 'danger' : 'primary', value: true }
        ]
      });
      return !!res;
    }

    // ===== Password lock for edit =====
    function randHex(len=16){
      const a = crypto.getRandomValues(new Uint8Array(len));
      return [...a].map(x=>x.toString(16).padStart(2,'0')).join('');
    }
    async function sha256Hex(str){
      const buf = await crypto.subtle.digest('SHA-256', te.encode(str));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function makeLockRecord(password){
      const salt = randHex(16);
      const hash = await sha256Hex(salt + '|' + password);
      return { salt, hash, createdAt: new Date().toISOString() };
    }
    async function verifyLock(password, record){
      if(!record?.salt || !record?.hash) return false;
      const hash = await sha256Hex(record.salt + '|' + password);
      return hash === record.hash;
    }
    function loadLock(){
      try{ return JSON.parse(localStorage.getItem(EDIT_LOCK_KEY) || 'null'); }catch{ return null; }
    }
    function saveLock(rec){ localStorage.setItem(EDIT_LOCK_KEY, JSON.stringify(rec)); }
    function clearLock(){ localStorage.removeItem(EDIT_LOCK_KEY); }

    async function openSetPassword() {
      if(!crypto?.subtle){
        toast('err','Không hỗ trợ','Trình duyệt không hỗ trợ WebCrypto.');
        return;
      }

      const existing = loadLock();

      const body = `
        <div class="card pad subtle" style="border-radius:22px;">
          <div class="section-title" style="margin-bottom:8px;">
            <h2 style="margin:0;font-size:14px;">Đặt/Đổi mật khẩu chỉnh sửa</h2>
            <span class="chip"><span class="icon" style="font-size:18px">lock</span>Security</span>
          </div>
          ${ existing ? `
          <label class="field">
            <span class="muted" style="font-size:12px">Mật khẩu hiện tại</span>
            <input class="input" id="curPwSet" type="password" placeholder="••••••••">
          </label>
          ` : '' }

          <label class="field">
            <span class="muted" style="font-size:12px">Mật khẩu mới</span>
            <input class="input" id="newPw" type="password" placeholder="••••••••">
          </label>
          <label class="field">
            <span class="muted" style="font-size:12px ;margin-top:6px">Nhập lại</span>
            <input class="input" id="newPw2" type="password" placeholder="••••••••">
          </label>

          <div class="row" style="justify-content:space-between; flex-wrap:wrap; margin-top:8px;">
            <span class="hint">Khuyên 8+ ký tự.</span>
            <button class="btn danger" id="resetLockBtn"><span class="icon">delete</span>Reset khoá<span class="ripple"></span></button>
          </div>
        </div>
      `;

      await openDialog({
        icon:'lock',
        title:'Mật khẩu chỉnh sửa',
        bodyHtml: body,
        actions: [
          { label:'Huỷ', icon:'close', value:null },
          {
            label:'Lưu mật khẩu',
            icon:'check',
            variant:'primary',
            onClick: async (closeAnd) => {
              const pw1 = $("#newPw")?.value || '';
              const pw2 = $("#newPw2")?.value || '';
              if(pw1.length < 6){ toast('err','Quá ngắn','Tối thiểu 6 ký tự (khuyên 8+).'); return; }
              if(pw1 !== pw2){ toast('err','Không khớp','Nhập lại không đúng.'); return; }

              // If there's an existing lock, require current password verification
              if(existing){
                const cur = $("#curPwSet")?.value || '';
                const ok = await verifyLock(cur, existing);
                if(!ok){ toast('err','Sai mật khẩu','Mật khẩu hiện tại không đúng.'); return; }
              }

              const rec = await makeLockRecord(pw1);
              saveLock(rec);
              toast('ok','Đã bật khoá','Từ giờ mở Chỉnh sửa sẽ yêu cầu mật khẩu.');
              closeAnd(true);
            }
          }
        ]
      });
      return;
    }
    // reset lock button click (delegation because dialog DOM dynamic)
    document.addEventListener('click', async (e) => {
      if(e.target.closest?.('#resetLockBtn')){
        const rec = loadLock();
        if(!rec){
          toast('err','Không tìm thấy khoá','Không có khoá để reset.');
          return;
        }

        const body = `
          <div class="card pad subtle" style="border-radius:22px;">
            <div class="section-title" style="margin-bottom:8px;">
              <h2 style="margin:0;font-size:14px;">Xác nhận mật khẩu hiện tại</h2>
              <span class="chip"><span class="icon" style="font-size:18px">lock_reset</span>Reset khoá</span>
            </div>
            <label class="field">
              <span class="muted" style="font-size:12px">Mật khẩu hiện tại</span>
              <input class="input" id="curPw" type="password" placeholder="••••••••">
            </label>
            <div class="hint">Nhập mật khẩu hiện tại để reset khoá. Nếu sai, thao tác sẽ bị huỷ.</div>
          </div>
        `;

        const ok = await openDialog({
          icon:'lock_reset',
          title:'Reset khoá chỉnh sửa',
          bodyHtml: body,
          actions: [
            { label:'Huỷ', icon:'close', value:null },
            {
              label:'Reset',
              icon:'delete',
              variant:'danger',
              onClick: async (closeAnd) => {
                const pw = $("#curPw")?.value || '';
                const pass = await verifyLock(pw, rec);
                if(!pass){
                  toast('err','Sai mật khẩu','Mật khẩu hiện tại không đúng.');
                  return;
                }
                clearLock();
                toast('ok','Đã reset khoá','Khoá chỉnh sửa đã tắt.');
                closeAnd(true);
              }
            }
          ]
        });

        if(ok){
          // đóng hộp thoại đặt/đổi mật khẩu (nếu đang mở)
          dlgClose();
        }
      }
    });

    async function requireEditPassword() {
      const rec = loadLock();
      if(!rec) return true;

      const body = `
        <div class="card pad subtle" style="border-radius:22px;">
          <div class="section-title" style="margin-bottom:8px;">
            <h2 style="margin:0;font-size:14px;">Nhập mật khẩu để chỉnh sửa</h2>
            <span class="chip"><span class="icon" style="font-size:18px">lock</span>Protected</span>
          </div>
          <label class="field">
            <span class="muted" style="font-size:12px">Mật khẩu</span>
            <input class="input" id="editPw" type="password" placeholder="••••••••">
          </label>
          <div class="hint">Sai mật khẩu sẽ không mở modal.</div>
        </div>
      `;

      const ok = await openDialog({
        icon:'lock_open',
        title:'Bảo vệ chỉnh sửa',
        bodyHtml: body,
        actions: [
          { label:'Huỷ', icon:'close', value:false },
          {
            label:'Mở',
            icon:'check',
            variant:'primary',
            onClick: async (closeAnd) => {
              const pw = $("#editPw")?.value || '';
              const pass = await verifyLock(pw, rec);
              if(!pass){ toast('err','Sai mật khẩu','Vui lòng thử lại.'); return; }
              closeAnd(true);
            }
          }
        ]
      });

      return !!ok;
    }

    // ===== Export / Import (plain) =====
    function download(filename, text){
      const blob = new Blob([text], {type:'application/json;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function escapeAttr(str){
      return String(str ?? '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    function isValidUrl(u){
      try{ if(!u) return false; const url = new URL(u); return url.protocol === 'http:' || url.protocol === 'https:' || url.protocol === 'mailto:'; }catch(e){ return false; }
    }
    function downloadText(filename, text, mime='text/plain;charset=utf-8'){
      const blob = new Blob([text], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function generateCvMarkdown(profile){
      const lines = [];
      lines.push(`# ${profile.name || ''}`);
      if(profile.title) lines.push(`**${profile.title}**`);
      if(profile.location) lines.push(`${profile.location}`);
      lines.push('');
      if(profile.phone) lines.push(`- Phone: ${profile.phone}`);
      if(profile.email) lines.push(`- Email: ${profile.email}`);
      if(profile.website) lines.push(`- Website: ${profile.website}`);
      lines.push('');
      if(profile.summary) lines.push(profile.summary, '');
      if(Array.isArray(profile.skills) && profile.skills.length){
        lines.push('## Skills', '');
        lines.push(profile.skills.join(' • '), '');
      }
      if(Array.isArray(profile.projectsFeatured) && profile.projectsFeatured.length){
        lines.push('## Projects', '');
        profile.projectsFeatured.forEach(p => {
          const title = p.title || 'Untitled';
          if(isValidUrl(p.url)) lines.push(`- [${title}](${p.url}) — ${p.desc || ''}`);
          else lines.push(`- ${title} — ${p.desc || ''}`);
        });
        lines.push('');
      }
      if(profile.experience) lines.push('## Experience', '', profile.experience, '');
      return lines.join('\n');
    }
    function getSafeFilename(){
      const name = (profile.name || 'profile').toLowerCase()
        .replace(/\s+/g,'-')
        .replace(/[^a-z0-9\-]/g,'');
      return name || 'profile';
    }

    async function applyImported(json){
      const imported = (json && json.__type === "profile_export" && json.data) ? json.data : json;
      if(!imported || typeof imported !== 'object') throw new Error('bad');

      const base = structuredClone(DEFAULT_PROFILE);
      const merged = {
        ...base, ...imported,
        stats: { ...base.stats, ...(imported.stats||{}) },
        skills: Array.isArray(imported.skills) ? imported.skills : base.skills,
        projectsFeatured: Array.isArray(imported.projectsFeatured) ? imported.projectsFeatured : base.projectsFeatured
      };
      merged.projectsFeatured = merged.projectsFeatured.map(p => ({ id: p.id || uid(), ...normalizeProject(p) }));
      profile = merged;
      saveProfileLocalStorage(profile);
      renderProfile();

      // Return merged profile object for further use
      return merged;
    }

    $("#exportBtn").addEventListener('click', () => {
      const payload = {
        __type: "profile_export",
        __version: 1,
        exportedAt: new Date().toISOString(),
        storageKey: STORAGE_KEY,
        data: profile
      };
      download(`${getSafeFilename()}-backup.json`, JSON.stringify(payload, null, 2));
      toast('ok','Export thành công','Đã tải file JSON backup.');
    });
    // Embedded fallback PDF (small sample) — used if /resume.pdf not present on server
    const SAMPLE_PDF_BASE64 = (
      'JVBERi0xLjQKJeLjz9MKMSAwIG9iago8PC9UeXBlL0NhdGFsb2cvUGFnZXMgMiAwIFI+PgplbmRvYmoK' +
      'MiAwIG9iago8PC9UeXBlL1BhZ2VzL0NvdW50IDEvS2lkc1sgMyAwIFJdPj4KZW5kb2JqCjMgMCBvYmog' +
      'PDwvVHlwZS9QYWdlL1BhcmVudCAyIDAgUi9NZWRpYUJveFswIDAgNjEyIDc5Ml0vUmVzb3VyY2VzPDwv' +
      'Rm9udDw8L0YxIDQgMCBSPj4+Pi9Db250ZW50cyA0IDAgUj4+CmVuZG9iago0IDAgb2JqCjw8L0xlbmd0' +
      'aCAxMT4+CnN0cmVhbQpCVAovRjEgMTQgVGYgMTIwIDcwMCBUZAooSGVsbG8sIFBERikgVGoKRVQKZW5k' +
      'c3RyZWFtCmVuZG9iago1IDAgb2JqCjw8L1R5cGUvRm9udC9TdWJ0eXBlL1R5cGUxL0Jhc2VGb250L0hl' +
      'bHZldGljYT4+CmVuZG9iagp4cmVmCjAgNgowMDAwMDAwMDAwIDY1NTM1IGYgCjAwMDAwMDAxMTkgMDAw' +
      'MDAgbiAKMDAwMDAwMDY0IDAwMDAwIG4gCjAwMDAwMDAxMDYgMDAwMDAgbiAKMDAwMDAwMDIyOCAwMDAw' +
      'MCBuIAp0cmFpbGVyPDwvU2l6ZSA2L1Jvb3QgMSAwIFIvSW5mbyA1IDAgUi9JRCBbPDAwMDAwMDAwMDAw' +
      'MDAwMD4gPDAwMDAwMDAwMDAwMDAwMD4+XT4+CnN0YXJ0eHJlZgozMDgKJSVFT0YK'
    );

    function base64ToUint8Array(b64){
      const bin = atob(b64);
      const len = bin.length;
      const u8 = new Uint8Array(len);
      for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
      return u8;
    }

    async function tryDownloadResume(){
      const name = getSafeFilename();
      console.log('tryDownloadResume called, attempting server resume.pdf');
      toast('ok','Bắt đầu tải','Đang thử tải resume.pdf từ máy chủ...');
      // try to fetch server file first
      try{
        const resp = await fetch('./resume.pdf', { method: 'HEAD' });
        if(resp.ok){
          const url = './resume.pdf';
          // try opening in new tab first (less likely to be blocked by some browsers)
          try{
            const w = window.open(url, '_blank');
            if(w) { toast('ok','Tải CV','Đang mở resume.pdf trong tab mới.'); return; }
          }catch(e){ /* ignored */ }

          const a = document.createElement('a');
          a.href = url;
          a.download = `${name}-resume.pdf`;
          document.body.appendChild(a);
          setTimeout(()=>{ a.click(); a.remove(); }, 60);
          toast('ok','Tải CV','Đang tải resume.pdf từ máy chủ.');
          return;
        }
      }catch(e){ console.warn('resume HEAD check failed', e); }

      // fallback to embedded PDF
      try{
        console.log('Falling back to embedded PDF');
        const u8 = base64ToUint8Array(SAMPLE_PDF_BASE64);
        const blob = new Blob([u8], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        // try opening blob URL in new tab first
        try{
          const w = window.open(url, '_blank');
          if(w){ toast('ok','Tải CV','Mở resume mẫu trong tab mới.'); setTimeout(()=> URL.revokeObjectURL(url), 20000); return; }
        }catch(e){ /* ignore */ }

        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}-resume.pdf`;
        document.body.appendChild(a);
        setTimeout(()=>{ a.click(); a.remove(); URL.revokeObjectURL(url); }, 60);
        toast('ok','Tải CV','Đã tải resume mẫu.');
      }catch(e){
        console.error('Embedded PDF fallback failed', e);
        // last resort: fallback to markdown CV
        const md = generateCvMarkdown(profile || {});
        downloadText(`${name}-CV.md`, md, 'text/markdown;charset=utf-8');
        toast('ok','Tải CV','Đã tải CV dưới dạng Markdown.');
      }
    }

    $("#downloadCvBtn").addEventListener('click', openExportPopup);

    function loadScript(url){
      return new Promise((resolve, reject) => {
        if(document.querySelector(`script[src="${url}"]`)) return resolve();
        const s = document.createElement('script');
        s.src = url;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load ' + url));
        document.head.appendChild(s);
      });
    }

    async function exportCv(format, opts = {}){
      // build a simple HTML representation of the CV
      const html = buildCvHtml(profile || {});
      const container = document.createElement('div');
      container.id = 'cvExportContainer';
      container.style.position = 'fixed';
      container.style.left = '-9999px';
      container.style.top = '0';
      // size: 'auto' (default) or 'A4'
      container.style.width = (opts.size === 'A4') ? '794px' : '800px';
      container.style.zIndex = '9999';
      container.innerHTML = html;
      document.body.appendChild(container);

      try{
        await loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
        const node = container;
        // determine scale from DPI option (base 96 CSS DPI)
        const dpi = parseInt(opts.dpi || '96', 10) || 96;
        const devicePR = window.devicePixelRatio || 1;
        const scale = (dpi / 96) * (opts.scale || 1) * devicePR;
        const html2c = (typeof window !== 'undefined' && (window.html2canvas || window.html2c)) || (typeof html2canvas !== 'undefined' ? html2canvas : null);
        if(!html2c) throw new Error('html2canvas not available');
        const canvas = await html2c(node, { scale: scale, backgroundColor: '#ffffff' });
        if(format === 'png' || format === 'jpg'){
          const mime = format === 'png' ? 'image/png' : 'image/jpeg';
          const quality = typeof opts.quality === 'number' ? opts.quality : 0.92;
          const dataUrl = mime === 'image/png' ? canvas.toDataURL('image/png') : canvas.toDataURL('image/jpeg', quality);
          if(opts.preview || opts.previewFullscreen){
            // prepare preview image
            const imgSrc = dataUrl;
            if(opts.previewFullscreen){
              // full-screen preview dialog
              await openDialog({ icon:'visibility', title: 'Xem trước (Full)', bodyHtml: `<div style="width:100vw;height:80vh;display:flex;align-items:center;justify-content:center;background:#111;"><img src="${imgSrc}" style="max-width:100%;max-height:100%;object-fit:contain;border:6px solid #fff;"/></div>`, actions: [
                { label: 'Tải PNG', icon: 'image', onClick: (close)=>{ const a = document.createElement('a'); a.href = imgSrc; a.download = `${getSafeFilename()}-CV.png`; document.body.appendChild(a); a.click(); a.remove(); close(); } },
                { label: 'Tải JPG', icon: 'portrait', onClick: (close)=>{ const jpg = canvas.toDataURL('image/jpeg', quality); const a = document.createElement('a'); a.href = jpg; a.download = `${getSafeFilename()}-CV.jpg`; document.body.appendChild(a); a.click(); a.remove(); close(); } },
                { label: 'Tải PDF', icon: 'picture_as_pdf', onClick: async (close)=>{ await exportCv('pdf', opts); close(); } },
                { label: 'Đóng', icon: 'close' }
              ]});
              container.remove();
              return;
            }else{
              await openDialog({ icon:'image', title: 'Xem trước', bodyHtml: `<div style="max-width:100%;"><img src="${imgSrc}" style="max-width:100%;height:auto;"/></div>`, actions: [
                { label: 'Tải PNG', icon: 'image', onClick: (close)=>{ const a = document.createElement('a'); a.href = imgSrc; a.download = `${getSafeFilename()}-CV.png`; document.body.appendChild(a); a.click(); a.remove(); close(); } },
                { label: 'Tải JPG', icon: 'portrait', onClick: (close)=>{ const jpg = canvas.toDataURL('image/jpeg', quality); const a = document.createElement('a'); a.href = jpg; a.download = `${getSafeFilename()}-CV.jpg`; document.body.appendChild(a); a.click(); a.remove(); close(); } },
                { label: 'Đóng', icon: 'close' }
              ]});
              container.remove();
              return;
            }
          }
          const a = document.createElement('a');
          a.href = dataUrl;
          a.download = `${getSafeFilename()}-CV.${format === 'png' ? 'png' : 'jpg'}`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          toast('ok','Tải CV',`Đã tải CV dưới dạng ${format.toUpperCase()}.`);
        }else if(format === 'pdf'){
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
          const dataUrl = canvas.toDataURL('image/png');
          const jspdfLib = (typeof window !== 'undefined' && window.jspdf) || (typeof jspdf !== 'undefined' ? jspdf : null);
          if(!jspdfLib) throw new Error('jsPDF not available');
          const jsPDF = jspdfLib.jsPDF || (jspdfLib.default && jspdfLib.default.jsPDF) || jspdfLib;
          // if A4 requested, fit to A4 page
          if(opts.size === 'A4'){
            const pdf = new jsPDF({ unit: 'px', format: 'a4' });
            const pw = pdf.internal.pageSize.getWidth();
            const ph = pdf.internal.pageSize.getHeight();
            const scaleFactor = Math.min(pw / canvas.width, ph / canvas.height);
            const w = canvas.width * scaleFactor;
            const h = canvas.height * scaleFactor;
            pdf.addImage(dataUrl, 'PNG', (pw - w) / 2, 0, w, h);
            pdf.save(`${getSafeFilename()}-CV.pdf`);
          }else{
            const pdf = new jsPDF({ unit: 'px', format: [canvas.width, canvas.height] });
            pdf.addImage(dataUrl, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save(`${getSafeFilename()}-CV.pdf`);
          }
          toast('ok','Tải CV','Đã tải CV dưới dạng PDF.');
        }else if(format === 'resume'){ // fetch server resume.pdf
          try{ const resp = await fetch('./resume.pdf'); if(resp.ok){ const blob = await resp.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${getSafeFilename()}-resume.pdf`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('ok','Tải CV','Đã tải resume.pdf từ máy chủ.'); }else{ throw new Error('no server resume'); } }catch(e){ toast('err','Không tìm thấy resume.pdf','Sẽ thử tải PDF được sinh.'); await exportCv('pdf', opts); }
        }
      }catch(e){
        console.error(e);
        toast('err','Xuất thất bại','Không thể xuất file.');
      }finally{
        container.remove();
      }
    }

    function buildCvHtml(profile){
      const name = escapeHtml(profile.name || '');
      const title = escapeHtml(profile.title || '');
      const summary = escapeHtml(profile.summary || '');
      const avatar = escapeAttr(profile.avatar || DEFAULT_PROFILE.avatar);
      const skills = (profile.skills||[]).map(s=>escapeHtml(s)).join(' • ');
      const projects = (profile.projectsFeatured||[]).map(p => {
        const t = escapeHtml(p.title || '');
        const desc = escapeHtml(p.desc || '');
        return `<div style="margin-bottom:10px;"><div style="font-weight:700;margin-bottom:4px;">${t}</div><div style="color:#444;font-size:13px;">${desc}</div></div>`;
      }).join('');
      return `
        <div style="font-family: Roboto, Arial, sans-serif; background:white; color:#111; padding:28px; width:760px; box-sizing:border-box;">
          <div style="display:flex; gap:16px; align-items:center;">
            <img src="${avatar}" style="width:120px;height:120px;border-radius:14px;object-fit:cover;border:1px solid #eee;"/>
            <div>
              <h1 style="margin:0 0 6px;font-size:26px;">${name}</h1>
              <div style="color:#666;margin-bottom:8px;">${title}</div>
              <div style="font-size:13px;color:#444;max-width:640px;">${summary}</div>
            </div>
          </div>
          <hr style="border:none;border-top:1px solid #eee;margin:18px 0;" />
          <div style="margin-bottom:12px;"><strong>Skills</strong><div style="color:#444;margin-top:6px;">${skills}</div></div>
          <div><strong>Projects</strong><div style="margin-top:8px;">${projects}</div></div>
        </div>
      `;
    }

    async function openExportPopup(){
      await openDialog({
        icon: 'download',
        title: 'Xuất CV',
        bodyHtml: `
          <div class="card pad" style="border-radius:14px;">
            <div class="stack">
                      <div class="hint">Chọn định dạng để xuất. PNG/JPG: ảnh màn hình CV. PDF: trang PDF chứa ảnh CV.</div>
                      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center;">
                        <label style="display:flex;gap:8px;align-items:center;">
                          <span class="muted">Khổ</span>
                          <select id="expSize" class="input" style="height:36px;padding:6px 8px;">
                            <option value="auto">Auto</option>
                            <option value="A4">A4</option>
                          </select>
                        </label>
                        <label style="display:flex;gap:8px;align-items:center;">
                          <span class="muted">Chất lượng</span>
                          <input id="expQuality" type="range" min="50" max="100" value="92" style="width:140px;" />
                          <span id="expQualityVal" class="muted" style="width:36px;text-align:right;">92</span>
                        </label>
                        <label style="display:flex;gap:8px;align-items:center;">
                          <span class="muted">DPI</span>
                          <select id="expDpi" class="input" style="height:36px;padding:6px 8px;">
                            <option value="96">96</option>
                            <option value="150">150</option>
                            <option value="300">300</option>
                          </select>
                        </label>
                        <label style="display:flex;gap:8px;align-items:center;">
                          <input id="expPreview" type="checkbox" checked /> <span class="muted">Xem trước</span>
                        </label>
                      </div>
                      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                        <button class="btn" id="expPngBtn"><span class="icon">image</span>PNG</button>
                        <button class="btn" id="expJpgBtn"><span class="icon">portrait</span>JPG</button>
                        <button class="btn" id="expPdfBtn"><span class="icon">picture_as_pdf</span>PDF</button>
                        <button class="btn" id="expResumeBtn"><span class="icon">file_download</span>resume.pdf</button>
                        <button class="btn" id="expMdBtn"><span class="icon">download</span>Markdown</button>
                        <button class="btn" id="expPreviewBtn"><span class="icon">visibility</span>Preview</button>
                        <button class="btn" id="expPreviewFullBtn"><span class="icon">open_in_full</span>Preview full</button>
                        <button class="btn primary" id="expDownloadNow" title="Tải ngay resume.pdf"><span class="icon">file_download</span>Tải ngay</button>
                        <label style="display:flex;align-items:center;gap:8px;margin-left:6px;">
                          <input id="expNoConfirm" type="checkbox" /> <span class="muted">Không hỏi lại</span>
                        </label>
                      </div>
            </div>
          </div>
        `,
        actions: [
          { label: 'Đóng', icon: 'close', variant: '' }
        ]
      });

      // wire buttons inside dialog
      setTimeout(()=>{
        const getOpts = () => ({ size: $('#expSize')?.value || 'auto', quality: (parseInt($('#expQuality')?.value||'92')/100), preview: !!$('#expPreview')?.checked, dpi: ($('#expDpi')?.value || '96') });
        $('#expQuality')?.addEventListener('input', (e)=>{ $('#expQualityVal').textContent = e.target.value; });

        // initialize 'Không hỏi lại' checkbox from localStorage
        const noConfirmKey = 'pref_no_export_confirm';
        const noConfirmCheckbox = $('#expNoConfirm');
        if(noConfirmCheckbox){
          try{ noConfirmCheckbox.checked = localStorage.getItem(noConfirmKey) === '1'; }catch(e){}
          noConfirmCheckbox.addEventListener('change', (e)=>{ try{ localStorage.setItem(noConfirmKey, e.target.checked ? '1' : '0'); }catch(_){}});
        }

        async function confirmAndExport(format, opts){
          // if user disabled confirm, proceed directly
          let skip = false;
          try{ skip = localStorage.getItem(noConfirmKey) === '1'; }catch(e){ skip = false; }
          if(!skip){
            const msg = `Bạn có chắc muốn xuất CV dưới dạng ${String(format).toUpperCase()}?`;
            const ok = await confirmDialog({ title: 'Xác nhận xuất', message: msg, icon: 'help', okText: 'Xuất', cancelText: 'Huỷ' });
            if(!ok){ toast('ok','Huỷ xuất','Đã huỷ thao tác xuất.'); return; }
          }
          if(format === 'md' || format === 'markdown'){
            const md = generateCvMarkdown(profile||{});
            downloadText(`${getSafeFilename()}-CV.md`, md, 'text/markdown;charset=utf-8');
            toast('ok','Tải CV','Đã tải CV dưới dạng Markdown.');
          }else{
            await exportCv(format, opts);
          }
        }

        $('#expPngBtn')?.addEventListener('click', ()=>{ const opts = getOpts(); confirmAndExport('png', opts); dlgClose(); });
        $('#expJpgBtn')?.addEventListener('click', ()=>{ const opts = getOpts(); confirmAndExport('jpg', opts); dlgClose(); });
        $('#expPdfBtn')?.addEventListener('click', ()=>{ const opts = getOpts(); confirmAndExport('pdf', opts); dlgClose(); });
        $('#expResumeBtn')?.addEventListener('click', ()=>{ const opts = getOpts(); confirmAndExport('resume', opts); dlgClose(); });
        $('#expMdBtn')?.addEventListener('click', ()=>{ const opts = getOpts(); confirmAndExport('md', opts); dlgClose(); });
        $('#expPreviewBtn')?.addEventListener('click', ()=>{ const opts = getOpts(); exportCv('png', {...opts, preview:true}); dlgClose(); });
        $('#expPreviewFullBtn')?.addEventListener('click', ()=>{ const opts = getOpts(); exportCv('png', {...opts, previewFullscreen:true}); dlgClose(); });
        $('#expDownloadNow')?.addEventListener('click', ()=>{ tryDownloadResume(); dlgClose(); });
      }, 30);
    }
    $("#importBtn").addEventListener('click', () => $("#importFile").click());
    $("#quickDownloadBtn").addEventListener('click', tryDownloadResume);
    $("#importFile").addEventListener('change', async () => {
      const file = $("#importFile").files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const json = JSON.parse(text);
        await applyImported(json);
        // Attempt to auto-sync after import if firebase is ready
        if(fb?.push){
          try{ await fb.push(profile); toast('ok','Import & Sync','Dữ liệu đã được import và đồng bộ lên Firebase.'); }
          catch(e){ console.error(e); toast('ok','Import thành công','Đã áp dụng dữ liệu và lưu (local). Đồng bộ thất bại.'); }
        }else{
          toast('ok','Import thành công','Đã áp dụng dữ liệu và lưu (local). Bấm Sync để đẩy lên Firebase.');
        }
      }catch(_){
        toast('err','Import thất bại','Không đọc được file JSON.');
      }finally{
        $("#importFile").value = '';
      }
    });

    $("#pushSampleBtn").addEventListener('click', async () => {
      try{
        const res = await fetch('sample-profile.json');
        if(!res.ok) throw new Error('fetch failed');
        const json = await res.json();
        await applyImported(json);
        if(fb?.push){
          try{ await fb.push(profile); toast('ok','Sample nạp & Sync','Sample đã nạp và đồng bộ lên Firebase.'); }
          catch(e){ console.error(e); toast('ok','Sample nạp','Sample đã nạp (local). Đồng bộ thất bại.'); }
        }else{
          toast('ok','Sample nạp','Sample đã nạp (local). Bấm Sync để đẩy lên Firebase.');
        }
      }catch(e){
        console.error(e);
        toast('err','Thất bại','Không thể nạp sample.');
      }
    });

    $("#syncNowBtn").addEventListener('click', async () => {
      if(!fb.ref){ toast('err','Chưa kết nối','Firebase chưa sẵn sàng hoặc chưa cấu hình.'); return; }
      try{
        setSyncBadge('syncing');
        await setDoc(fb.ref, { data: profile, updatedAt: new Date().toISOString() }, { merge:true });
        setSyncBadge('online');
        toast('ok','Đã sync','Dữ liệu đã được đẩy lên Firebase.');
      }catch(e){
        console.error(e);
        setSyncBadge('offline');
        toast('err','Sync thất bại','Không thể đẩy dữ liệu lên Firebase.');
      }
    });

    // ===== UI render =====
    let profile = loadProfile();

    const ui = {
      avatar: $("#ui_avatar"),
      name: $("#ui_name"),
      title: $("#ui_title"),
      location: $("#ui_location"),
      statProjects: $("#ui_stat_projects"),
      statFollowers: $("#ui_stat_followers"),
      statRating: $("#ui_stat_rating"),
      statExperience: $("#ui_stat_experience"),
      statClients: $("#ui_stat_clients"),
      statAwards: $("#ui_stat_awards"),
      phone: $("#ui_phone"),
      emailLink: $("#ui_email_link"),
      siteLink: $("#ui_site_link"),
      bio: $("#ui_bio"),
      skills: $("#ui_skills"),
      projectGrid: $("#projectGrid"),
      previewAvatar: $("#previewAvatar"),
      syncBadge: $("#syncBadge")
    };

    function renderSkills(){
      ui.skills.innerHTML = '';
      (profile.skills || []).filter(Boolean).slice(0, 14).forEach(s=>{
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span class="icon" style="font-size:18px">bolt</span>${escapeHtml(s)}`;
        ui.skills.appendChild(chip);
      });
    }
    function renderFeaturedProjects(){
      ui.projectGrid.innerHTML = '';
      (profile.projectsFeatured || []).forEach(p=>{
        const card = document.createElement('div');
        card.className = 'p-card';
        card.setAttribute('data-title', p.title || '');
        const tags = Array.isArray(p.tags) ? p.tags : [];
        const titleHtml = isValidUrl(p.url || '')
          ? `<a class="p-title" href="${escapeAttr(p.url)}" target="_blank" rel="noopener">${escapeHtml(p.title || '')}</a>`
          : `<p class="p-title">${escapeHtml(p.title || '')}</p>`;
        card.innerHTML = `
          <div class="p-top">
            ${titleHtml}
            <span class="chip"><span class="icon" style="font-size:18px">${escapeHtml(p.badgeIcon||'rocket_launch')}</span>${escapeHtml(p.badge||'')}</span>
          </div>
          <p class="p-desc">${escapeHtml(p.desc || '')}</p>
          <div class="p-tags">${tags.slice(0,6).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>
        `;
        ui.projectGrid.appendChild(card);
      });
    }
    function renderProfile(){
      ui.avatar.src = profile.avatar || DEFAULT_PROFILE.avatar;
      attachImageFallback(ui.avatar);
      ui.name.textContent = profile.name || '';
      ui.title.textContent = profile.title || '';
      ui.location.textContent = profile.location || '';

      ui.statProjects.textContent = profile.stats?.projects ?? '';
      ui.statFollowers.textContent = profile.stats?.followers ?? '';
      ui.statRating.textContent = profile.stats?.rating ?? '';
      ui.statExperience.textContent = profile.stats?.experience ?? '';
      ui.statClients.textContent = profile.stats?.clients ?? '';
      ui.statAwards.textContent = profile.stats?.awards ?? '';

      ui.phone.textContent = profile.phone || '';

      const email = String(profile.email || '').trim();
      ui.emailLink.textContent = email || '-';
      ui.emailLink.href = email ? `mailto:${email}` : '#';

      const site = String(profile.site || '').trim();
      ui.siteLink.textContent = site ? site.replace(/^https?:\/\//,'') : '-';
      ui.siteLink.href = site ? safeUrl(site) : '#';

      ui.bio.textContent = profile.bio || '';
      ui.previewAvatar.src = profile.avatar || DEFAULT_PROFILE.avatar;
      attachImageFallback(ui.previewAvatar);

      renderSkills();
      renderFeaturedProjects();
    }
    renderProfile();

    // Search
    $("#search").addEventListener('input', () => {
      const q = $("#search").value.trim().toLowerCase();
      [...ui.projectGrid.querySelectorAll('.p-card')].forEach(c => {
        const t = (c.getAttribute('data-title') || c.innerText).toLowerCase();
        c.style.display = t.includes(q) ? '' : 'none';
      });
    });

    // ===== Edit modal =====
    const backdrop = $("#backdrop");
    function closeModal(){
      backdrop.classList.remove('show');
      document.documentElement.style.overflow = '';
    }
    $("#closeModalBtn").addEventListener('click', closeModal);
    backdrop.addEventListener('click', (e) => { if(e.target === backdrop) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && backdrop.classList.contains('show')) closeModal(); });

    function fillEditForm(){
      $("#f_name").value = profile.name || '';
      $("#f_title").value = profile.title || '';
      $("#f_location").value = profile.location || '';
      $("#f_phone").value = profile.phone || '';
      $("#f_email").value = profile.email || '';
      $("#f_site").value = profile.site || '';
      $("#f_bio").value = profile.bio || '';
      $("#f_projects").value = profile.stats?.projects ?? '';
      $("#f_followers").value = profile.stats?.followers ?? '';
      $("#f_rating").value = profile.stats?.rating ?? '';
      $("#f_experience").value = profile.stats?.experience ?? '';
      $("#f_clients").value = profile.stats?.clients ?? '';
      $("#f_awards").value = profile.stats?.awards ?? '';
      $("#f_skills").value = (profile.skills || []).join(', ');

      $("#previewAvatar").src = profile.avatar || DEFAULT_PROFILE.avatar;
      $("#avatarFile").value = '';
      delete $("#previewAvatar").dataset.removed;
    }

    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    $("#avatarFile").addEventListener('change', async () => {
      const file = $("#avatarFile").files?.[0];
      if(!file) return;
      if(!/^image\//.test(file.type)){
        toast('err','Sai định dạng','Vui lòng chọn file ảnh.');
        $("#avatarFile").value = '';
        return;
      }
      if(file.size > 2.2 * 1024 * 1024){
        toast('err','Ảnh quá lớn','Chọn ảnh <= ~2MB để lưu ổn định.');
        $("#avatarFile").value = '';
        return;
      }
      $("#previewAvatar").src = await fileToDataURL(file);
      delete $("#previewAvatar").dataset.removed;
      toast('ok','Đã chọn ảnh','Nhấn “Lưu” để cập nhật.');
    });
    $("#removeAvatarBtn").addEventListener('click', () => {
      $("#previewAvatar").src = DEFAULT_PROFILE.avatar;
      $("#previewAvatar").dataset.removed = '1';
      $("#avatarFile").value = '';
      toast('ok','Đã xoá ảnh','Nhấn “Lưu” để áp dụng.');
    });

    // Projects editor
    let projectsBuffer = structuredClone(profile.projectsFeatured || []);

    function wireDrop(list){
      list.addEventListener('dragover', (e) => {
        e.preventDefault();
        const dragging = list.querySelector('.pitem.dragging');
        const after = getDragAfterElement(list, e.clientY);
        if(!dragging) return;
        if(after == null) list.appendChild(dragging);
        else list.insertBefore(dragging, after);
      });

      list.addEventListener('drop', (e) => {
        e.preventDefault();
        const ids = [...list.querySelectorAll('.pitem')].map(x => x.dataset.id);
        projectsBuffer.sort((a,b) => ids.indexOf(a.id) - ids.indexOf(b.id));
        renderProjectEditorFromBuffer();
      });
    }
    function getDragAfterElement(container, y){
      const els = [...container.querySelectorAll('.pitem:not(.dragging)')];
      return els.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if(offset < 0 && offset > closest.offset){
          return { offset, element: child };
        }
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function renderProjectEditor(){
      projectsBuffer = structuredClone(profile.projectsFeatured || []).map(normalizeProject);
      const list = $("#projectList");
      list.innerHTML = '';

      projectsBuffer.forEach((p, idx) => {
        const item = document.createElement('div');
        item.className = 'pitem';
        item.draggable = true;
        item.dataset.id = p.id;

        item.innerHTML = `
          <div class="head">
            <div class="left">
              <div class="drag-handle" title="Kéo để sắp xếp"><span class="icon">drag_indicator</span></div>
              <div class="pitem-title">
                <b>#${idx+1} — ${escapeHtml(p.title || 'Dự án mới')}</b>
                <small>${escapeHtml((p.badgeIcon||'') + ' • ' + (p.badge||''))}</small>
              </div>
            </div>
            <div class="row" style="gap:8px;">
              <button class="btn icon" data-act="up" title="Lên"><span class="icon">arrow_upward</span><span class="ripple"></span></button>
              <button class="btn icon" data-act="down" title="Xuống"><span class="icon">arrow_downward</span><span class="ripple"></span></button>
              <button class="btn icon danger" data-act="del" title="Xoá"><span class="icon">delete</span><span class="ripple"></span></button>
            </div>
          </div>

          <div class="grid3">
            <label class="field"><span class="muted" style="font-size:12px">Tiêu đề</span>
              <input class="input mini" data-k="title" value="${escapeHtml(p.title)}">
            </label>
            <label class="field"><span class="muted" style="font-size:12px">Badge</span>
              <input class="input mini" data-k="badge" value="${escapeHtml(p.badge)}">
            </label>
            <label class="field"><span class="muted" style="font-size:12px">Icon badge</span>
              <input class="input mini" data-k="badgeIcon" value="${escapeHtml(p.badgeIcon)}">
              <div class="hint">VD: rocket_launch / print / favorite / insights</div>
            </label>
          </div>

          <label class="field"><span class="muted" style="font-size:12px">Mô tả</span>
            <textarea class="input" data-k="desc">${escapeHtml(p.desc)}</textarea>
          </label>

          <label class="field"><span class="muted" style="font-size:12px">Tags (phân cách ,)</span>
            <input class="input mini" data-k="tags" value="${escapeHtml((p.tags||[]).join(', '))}">
          </label>

          <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
            <span class="badge"><span class="icon" style="font-size:18px">info</span>ID: ${escapeHtml(p.id)}</span>
            <span class="hint">Kéo thả hoặc dùng ↑/↓.</span>
          </div>
        `;

        item.addEventListener('input', (e) => {
          const el = e.target;
          const k = el?.dataset?.k;
          if(!k) return;
          const id = item.dataset.id;
          const i = projectsBuffer.findIndex(x => x.id === id);
          if(i < 0) return;

          if(k === 'tags'){
            projectsBuffer[i].tags = String(el.value||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0, 10);
          }else{
            projectsBuffer[i][k] = String(el.value||'');
          }
        });

        item.addEventListener('click', async (e) => {
          const btn = e.target.closest?.('button[data-act]');
          if(!btn) return;
          const act = btn.dataset.act;
          const id = item.dataset.id;
          const i = projectsBuffer.findIndex(x => x.id === id);
          if(i < 0) return;

          if(act === 'del'){
            const ok = await confirmDialog({
              title:'Xoá dự án',
              message:'Bạn chắc chắn muốn xoá dự án này?',
              icon:'delete',
              danger:true,
              okText:'Xoá'
            });
            if(!ok) return;
            projectsBuffer.splice(i, 1);
            renderProjectEditorFromBuffer();
            return;
          }
 if(act === 'up' && i > 0){
            [projectsBuffer[i-1], projectsBuffer[i]] = [projectsBuffer[i], projectsBuffer[i-1]];
            renderProjectEditorFromBuffer();
            return;
          }
          if(act === 'down' && i < projectsBuffer.length - 1){
            [projectsBuffer[i+1], projectsBuffer[i]] = [projectsBuffer[i], projectsBuffer[i+1]];
            renderProjectEditorFromBuffer();
            return;
          }
        });

        item.addEventListener('dragstart', (e) => {
          item.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', item.dataset.id);
          $("#dropzone").classList.add('on');
        });
        item.addEventListener('dragend', () => {
          item.classList.remove('dragging');
          $("#dropzone").classList.remove('on');
        });

        list.appendChild(item);
      });

      wireDrop(list);
    }

    function renderProjectEditorFromBuffer(){
      const keep = profile;
      const temp = structuredClone(profile);
      temp.projectsFeatured = structuredClone(projectsBuffer);
      profile = temp;
      renderProjectEditor();
      profile = keep;
      toast('ok','Đã cập nhật','Danh sách dự án đã đổi (nhấn Lưu để ghi).');
    }

    $("#addProjectBtn").addEventListener('click', () => {
      projectsBuffer.unshift({
        id: uid(),
        title: 'Dự án mới',
        badge: 'New',
        badgeIcon: 'auto_awesome',
        desc: 'Mô tả ngắn về dự án...',
        tags: ['Tag1','Tag2']
      });
      renderProjectEditorFromBuffer();
    });

    $("#editBtn").addEventListener('click', async () => {
      const allow = await requireEditPassword();
      if(!allow) return;

      fillEditForm();
      renderProjectEditor();
      backdrop.classList.add('show');
      document.documentElement.style.overflow = 'hidden';
      setTimeout(()=> $("#f_name")?.focus(), 20);
    });

    $("#saveBtn").addEventListener('click', async () => {
      const next = structuredClone(profile);

      next.name = $("#f_name").value.trim();
      next.title = $("#f_title").value.trim();
      next.location = $("#f_location").value.trim();
      next.phone = $("#f_phone").value.trim();
      next.email = $("#f_email").value.trim();
      next.site = $("#f_site").value.trim();
      next.bio = $("#f_bio").value.trim();

      next.stats = {
        projects: $("#f_projects").value.trim(),
        followers: $("#f_followers").value.trim(),
        rating: $("#f_rating").value.trim(),
        experience: $("#f_experience").value.trim(),
        clients: $("#f_clients").value.trim(),
        awards: $("#f_awards").value.trim()

      };

      const skills = $("#f_skills").value.split(',').map(s=>s.trim()).filter(Boolean).slice(0, 24);
      next.skills = skills.length ? skills : structuredClone(DEFAULT_PROFILE.skills);

      if(!next.name){ toast('err','Thiếu thông tin','Vui lòng nhập họ tên.'); $("#f_name").focus(); return; }
      if(next.email && !validateEmail(next.email)){ toast('err','Email không hợp lệ','Vui lòng kiểm tra lại email.'); $("#f_email").focus(); return; }

      if($("#previewAvatar").dataset.removed === '1'){
        next.avatar = DEFAULT_PROFILE.avatar;
        delete $("#previewAvatar").dataset.removed;
      }else{
        next.avatar = $("#previewAvatar").src || DEFAULT_PROFILE.avatar;
      }

      next.projectsFeatured = structuredClone(projectsBuffer).map(normalizeProject).filter(p => p.title || p.desc);
      if(next.projectsFeatured.length === 0) next.projectsFeatured = structuredClone(DEFAULT_PROFILE.projectsFeatured);

      profile = next;
      saveProfileLocalStorage(profile);
      renderProfile();
      // Attempt to sync immediately if firebase push helper is available
      if(fb?.push){
        try{
          await fb.push(profile);
          toast('ok','Đã lưu & đồng bộ','Hồ sơ đã lưu và đồng bộ lên Firebase.');
        }catch(e){
          console.error(e);
          toast('ok','Đã lưu','Hồ sơ đã lưu local. Đồng bộ thất bại.');
        }
      }else{
        toast('ok','Đã lưu','Hồ sơ đã lưu (local). Bấm Sync để đẩy lên Firebase.');
      }
      closeModal();
    });

    $("#lockBtn").addEventListener('click', openSetPassword);

    // Reset profile (no browser confirm)
    $("#resetProfileBtn").addEventListener('click', async () => {
      const ok = await confirmDialog({
        title:'Reset hồ sơ',
        message:'Reset toàn bộ hồ sơ về mặc định? (Không thể hoàn tác)',
        icon:'restart_alt',
        danger:true,
        okText:'Reset'
      });
      if(!ok) return;

      profile = structuredClone(DEFAULT_PROFILE);
      saveProfileLocalStorage(profile);
      renderProfile();
      // Attempt to auto-sync reset to Firebase
      if(fb?.push){
        try{ await fb.push(profile); toast('ok','Đã reset & Sync','Hồ sơ đã reset và đồng bộ lên Firebase.'); }
        catch(e){ console.error(e); toast('ok','Đã reset','Hồ sơ đã reset (local). Đồng bộ thất bại.'); }
      }else{
        toast('ok','Đã reset','Hồ sơ đã reset (local). Bấm Sync để đẩy lên Firebase.');
      }
    });

    // ===== Dock actions =====
    $("#dockTheme")?.addEventListener('click', () => $("#themeBtn")?.click());
    $("#dockExport")?.addEventListener('click', () => openExportPopup());
    $("#dockImport")?.addEventListener('click', () => $("#importBtn")?.click());
    $("#dockLock")?.addEventListener('click', () => openSetPassword());
    $("#dockEdit")?.addEventListener('click', () => $("#editBtn")?.click());

    // ===== Firebase sync (hook saveProfile) =====
    let fb = { ready:false, uid:null, ref:null, unsub:null };
    const syncBadge = ui.syncBadge;

    function setSyncBadge(state){
      if(!syncBadge) return;
      if(state === 'online'){
        syncBadge.innerHTML = `<span class="icon" style="font-size:18px">cloud_done</span>Synced`;
      }else if(state === 'syncing'){
        syncBadge.innerHTML = `<span class="icon" style="font-size:18px">cloud_sync</span>Sync...`;
      }else{
        syncBadge.innerHTML = `<span class="icon" style="font-size:18px">cloud_off</span>Offline`;
      }
    }

    // base saveProfileLocal (always available) — only saves to localStorage
    function saveProfileLocal(p){
      saveProfileLocalStorage(p);
    }
    // keep old name for internal simple usage
    function saveProfileLocalStorage(p){ localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }

    async function initFirebase(){
      try{
        console.log('initFirebase: firebaseConfig=', firebaseConfig);
        // allow app even if user hasn't changed config yet
        // treat as "not configured" when apiKey or projectId is missing
        if(!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId){
          setSyncBadge('offline');
          return;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        setSyncBadge('syncing');
        await signInAnonymously(auth);

        onAuthStateChanged(auth, async (user) => {
          if(!user) return;

          fb.uid = user.uid;
          fb.ref = doc(db, 'users', user.uid, 'profile', 'main');

            // provide helper to push local -> firebase on demand
            fb.push = async (p) => {
              if(!fb.ref) throw new Error('no-ref');
              try{
                setSyncBadge('syncing');
                await setDoc(fb.ref, { data: p, updatedAt: new Date().toISOString() }, { merge:true });
                setSyncBadge('online');
              }catch(e){
                setSyncBadge('offline');
                throw e;
              }
            };

          // load once
          try{
            const snap = await getDoc(fb.ref);
            if(snap.exists()){
              const data = snap.data()?.data;
              if(data){
                profile = data;
                saveProfileLocal(profile);
                renderProfile();
              }
            }else{
              await setDoc(fb.ref, { data: profile, updatedAt: new Date().toISOString() }, { merge:true });
            }
            setSyncBadge('online');
          }catch{
            setSyncBadge('offline');
          }

          // realtime listen
          try{
            if(fb.unsub) fb.unsub();
            fb.unsub = onSnapshot(fb.ref, (s) => {
              const incoming = s.data()?.data;
              if(!incoming) return;
              const now = JSON.stringify(profile);
              const inc = JSON.stringify(incoming);
              if(now !== inc){
                profile = incoming;
                saveProfileLocal(profile);
                renderProfile();
              }
              setSyncBadge('online');
            });
          }catch{
            setSyncBadge('offline');
          }
        });

      }catch(e){
        setSyncBadge('offline');
        console.error('initFirebase error:', e);
      }
    }

    initFirebase();

    // Footer year
    $("#year").textContent = new Date().getFullYear();
  </script>
</body>
</html>
